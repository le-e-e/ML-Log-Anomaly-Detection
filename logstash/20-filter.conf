# /etc/logstash/conf.d/20-filter.conf
filter {
  # host.name 통일(배포에 따라 host.hostname만 있을 수 있음)
  if [host][name] == "" and [host][hostname] != "" {
    mutate { rename => { "[host][hostname]" => "[host][name]" } }
  }

  #기본 데이터셋(없으면 syslog로)
  if ![event][dataset] {
    mutate { add_field => { "[event][dataset]" => "system.syslog" } }
  }

  # cron 식별(파일 경로나 program으로)
  if [log][file][path] =~ "/var/log/cron" or [program] =~ /^(cron|crond)$/ or [log_source] == "cron" {
    mutate { replace => { "[event][dataset]" => "cron" } }
  }

  # dpkg 식별(파일 경로나 메시지 키워드)
  if [log][file][path] =~ "dpkg\.log" or [log_source] == "dpkg" or "dpkg" in [message] {
    mutate { replace => { "[event][dataset]" => "dpkg" } }
  }

  # 커널 라벨(배포/모듈에 따라 조정)
  if [syslog][facility] == "kern" or [program] == "kernel" {
    mutate { replace => { "[event][dataset]" => "system.kernel" } }
  }

  # PII/토큰 최소 마스킹(원문 보존)
  mutate {
    gsub => [
      "message", "(?i)(authorization:\s*bearer\s+)[A-Za-z0-9._-]+", "\1***"
    ]
  }
}
